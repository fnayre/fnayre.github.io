<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.6cde349a8e8a1fa7b83e.css" id="gatsby-global-css">@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}


/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden]{display:none}:root{--maxWidth-none:"none";--maxWidth-xs:20rem;--maxWidth-sm:24rem;--maxWidth-md:28rem;--maxWidth-lg:32rem;--maxWidth-xl:36rem;--maxWidth-2xl:42rem;--maxWidth-3xl:48rem;--maxWidth-4xl:56rem;--maxWidth-full:"100%";--maxWidth-wrapper:var(--maxWidth-2xl);--spacing-px:"1px";--spacing-0:0;--spacing-1:0.25rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--spacing-20:5rem;--spacing-24:6rem;--spacing-32:8rem;--fontFamily-sans:Montserrat,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--fontFamily-serif:"Merriweather","Georgia",Cambria,"Times New Roman",Times,serif;--font-body:var(--fontFamily-serif);--font-heading:var(--fontFamily-sans);--fontWeight-normal:400;--fontWeight-medium:500;--fontWeight-semibold:600;--fontWeight-bold:700;--fontWeight-extrabold:800;--fontWeight-black:900;--fontSize-root:16px;--lineHeight-none:1;--lineHeight-tight:1.1;--lineHeight-normal:1.5;--lineHeight-relaxed:1.625;--fontSize-0:0.833rem;--fontSize-1:1rem;--fontSize-2:1.2rem;--fontSize-3:1.44rem;--fontSize-4:1.728rem;--fontSize-5:2.074rem;--fontSize-6:2.488rem;--fontSize-7:2.986rem;--color-primary:#005b99;--color-text:#2e353f;--color-text-light:#4f5969;--color-heading:#1a202c;--color-heading-black:#000;--color-accent:#d1dce5}*,:after,:before{box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:var(--fontSize-root);line-height:var(--lineHeight-normal)}body{color:var(--color-text);font-family:var(--font-body);font-size:var(--fontSize-1)}footer{padding:var(--spacing-6) var(--spacing-0)}hr{background:var(--color-accent);border:0;height:1px}h1,h2,h3,h4,h5,h6{font-family:var(--font-heading);letter-spacing:-.025em;line-height:var(--lineHeight-tight);margin-bottom:var(--spacing-6);margin-top:var(--spacing-12)}h2,h3,h4,h5,h6{color:var(--color-heading);font-weight:var(--fontWeight-bold)}h1{color:var(--color-heading-black);font-size:var(--fontSize-6);font-weight:var(--fontWeight-black)}h2{font-size:var(--fontSize-5)}h3{font-size:var(--fontSize-4)}h4{font-size:var(--fontSize-3)}h5{font-size:var(--fontSize-2)}h6{font-size:var(--fontSize-1)}h1>a,h2>a,h3>a,h4>a,h5>a,h6>a{color:inherit;text-decoration:none}p{--baseline-multiplier:0.179;--x-height-multiplier:0.35;line-height:var(--lineHeight-relaxed);margin:var(--spacing-0) var(--spacing-0) var(--spacing-8) var(--spacing-0)}ol,p,ul{padding:var(--spacing-0)}ol,ul{list-style-image:none;list-style-position:outside;margin-bottom:var(--spacing-8);margin-left:var(--spacing-0);margin-right:var(--spacing-0)}ol li,ul li{padding-left:var(--spacing-0)}li>p,ol li,ul li{margin-bottom:calc(var(--spacing-8)/2)}li :last-child{margin-bottom:var(--spacing-0)}li>ul{margin-left:var(--spacing-8);margin-top:calc(var(--spacing-8)/2)}blockquote{border-left:var(--spacing-1) solid var(--color-primary);color:var(--color-text-light);font-size:var(--fontSize-2);font-style:italic;margin-bottom:var(--spacing-8);margin-left:calc(var(--spacing-6)*-1);margin-right:var(--spacing-8);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-6)}blockquote>:last-child{margin-bottom:var(--spacing-0)}blockquote>ol,blockquote>ul{list-style-position:inside}table{border-collapse:collapse;border-spacing:.25rem;margin-bottom:var(--spacing-8);width:100%}table thead tr th{border-bottom:1px solid var(--color-accent)}a{color:var(--color-primary)}a:focus,a:hover{text-decoration:none}.global-wrapper{margin:var(--spacing-0) auto;max-width:var(--maxWidth-wrapper);padding:var(--spacing-10) var(--spacing-5)}.global-wrapper[data-is-root-path=true] .bio{margin-bottom:var(--spacing-20)}.global-header{margin-bottom:var(--spacing-12)}.main-heading{font-size:var(--fontSize-7);margin:0}.post-list-item{margin-bottom:var(--spacing-8);margin-top:var(--spacing-8)}.post-list-item p{margin-bottom:var(--spacing-0)}.post-list-item h2{color:var(--color-primary);font-size:var(--fontSize-4);margin-bottom:var(--spacing-2);margin-top:var(--spacing-0)}.post-list-item header{margin-bottom:var(--spacing-4)}.header-link-home{font-family:var(--font-heading);font-size:var(--fontSize-2);font-weight:var(--fontWeight-bold);text-decoration:none}.bio{display:flex;margin-bottom:var(--spacing-16)}.bio-avatar,.bio p{margin-bottom:var(--spacing-0)}.bio-avatar{border-radius:100%;margin-right:var(--spacing-4);min-width:50px}.blog-post header h1{margin:var(--spacing-0) var(--spacing-0) var(--spacing-4) var(--spacing-0)}.blog-post header p{font-family:var(--font-heading);font-size:var(--fontSize-2)}.blog-post-nav ul{margin:var(--spacing-0)}.gatsby-highlight{margin-bottom:var(--spacing-8)}@media (max-width:42rem){blockquote{margin-left:var(--spacing-0);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-4)}ol,ul{list-style-position:inside}}code[class*=language-],pre[class*=language-]{color:#393a34;direction:ltr;font-family:Consolas,Bitstream Vera Sans Mono,Courier New,Courier,monospace;font-size:.9em;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.2em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre>code[class*=language-]{font-size:1em}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#c1def1}pre[class*=language-]{background-color:#f6f8fa;border-radius:6px;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{background-color:#1b1f230d;border-radius:4px;padding:1px .2em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:green;font-style:italic}.token.namespace{opacity:.7}.token.string{color:#a31515}.token.operator,.token.punctuation{color:#393a34}.token.boolean,.token.constant,.token.inserted,.token.number,.token.symbol,.token.url,.token.variable{color:#36acaa}.language-autohotkey .token.selector,.language-json .token.boolean,.language-json .token.number,.token.atrule,.token.attr-value,.token.keyword,code[class*=language-css]{color:#00f}.token.function{color:#393a34}.language-autohotkey .token.tag,.token.deleted{color:#9a050f}.language-autohotkey .token.keyword,.token.selector{color:#00009f}.token.important{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.language-json .token.property,.token.class-name{color:#2b91af}.token.selector,.token.tag{color:maroon}.token.attr-name,.token.entity,.token.property,.token.regex{color:red}.token.directive.tag .tag{background:#ff0;color:#393a34}.line-numbers .line-numbers-rows{border-right-color:#a5a5a5}.line-numbers-rows>span:before{color:#2b91af}.line-highlight{background:rgba(193,222,241,.2);background:linear-gradient(90deg,rgba(193,222,241,.2) 70%,rgba(221,222,241,0))}</style><meta name="generator" content="Gatsby 3.6.2"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><title data-react-helmet="true">Algebraic Effects in JavaScript part 4 - Implementing Algebraic Effects and Handlers | Abstract fun</title><meta data-react-helmet="true" name="description" content="This is the final part of a series about Algebraic Effects and Handlers. Part 1 : continuations and control transfer Part 2 : Capturing continuations with…"/><meta data-react-helmet="true" property="og:title" content="Algebraic Effects in JavaScript part 4 - Implementing Algebraic Effects and Handlers"/><meta data-react-helmet="true" property="og:description" content="This is the final part of a series about Algebraic Effects and Handlers. Part 1 : continuations and control transfer Part 2 : Capturing continuations with…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="YassineElouafi2"/><meta data-react-helmet="true" name="twitter:title" content="Algebraic Effects in JavaScript part 4 - Implementing Algebraic Effects and Handlers"/><meta data-react-helmet="true" name="twitter:description" content="This is the final part of a series about Algebraic Effects and Handlers. Part 1 : continuations and control transfer Part 2 : Capturing continuations with…"/><link as="script" rel="preload" href="/webpack-runtime-787195f1393efa40968d.js"/><link as="script" rel="preload" href="/framework-c4b9952841844d9091bc.js"/><link as="script" rel="preload" href="/app-be01091e8f6277f5b6f6.js"/><link as="script" rel="preload" href="/commons-140fdb61bcb6fdaf6bd2.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-664fa24895fa0bb62323.js"/><link as="fetch" rel="preload" href="/page-data/2018-11-19-algebraic-effects-series-4/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2841359383.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3257411868.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper" data-is-root-path="false"><header class="global-header"><a class="header-link-home" href="/">Abstract fun</a></header><main><article class="blog-post" itemscope="" itemType="http://schema.org/Article"><header><h1 itemProp="headline">Algebraic Effects in JavaScript part 4 - Implementing Algebraic Effects and Handlers</h1><p>November 19, 2018</p></header><section itemProp="articleBody"><p>This is the final part of a series about Algebraic Effects and Handlers.</p>
<ul>
<li>Part 1 : <a href="/2018-11-19-algebraic-effects-series-1">continuations and control transfer</a></li>
<li>Part 2 : <a href="/2018-11-19-algebraic-effects-series-2">Capturing continuations with Generators</a></li>
<li>Part 3 : <a href="/2018-11-19-algebraic-effects-series-3">Delimited continuations</a></li>
<li><strong>Part 4 : Implementing Algebraic Effects and handlers</strong></li>
</ul>
<p>So we’ve come to the core topic. The reality is that we’ve already covered most of it in the previous parts. Especially, in the third part, where we saw delimited continuations at work.</p>
<p>In this part, we’ll see that the mechanism of Algebraic Effects isn’t much different from that of delimited continuations. But first, let’s approach the topic from a more familiar perspective. We’ll exploit the similarity with JavaScript Error handling to introduce the concept.</p>
<h3>From Exceptions to Algebraic Effects</h3>
<p>Below a simple example of Error handling. Don’t pay much attention to the program logic, all we’re interested on are the mechanics of the Call Stack.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">unsafeOperation</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">unsafeOperation</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">oneMoreIndirection</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
  <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">oneMoreIndirection</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token string">"cant be under zero!"</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> n <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// => 0</span></code></pre></div>
<p>Once we reach the <code class="language-text">oneMoreIndirection</code>, the Call Stack looks like:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main(-1) -&gt; handler(-1) -&gt; unsafeOperation(-1) -&gt; oneMoreIndirection(-1)</code></pre></div>
<p>When <code class="language-text">oneMoreIndirection</code> throws, the exception bubbles up to the closest <code class="language-text">try</code>/<code class="language-text">catch</code> block, which in this case is located in <code class="language-text">handler</code>. All stack frames below that handler (<code class="language-text">oneMoreIndirection(-1) -&gt; unsafeOperation(-1)</code>) are discarded. So the Call Stack becomes like:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; handler()</code></pre></div>
<p>Now, let’s envision what those discarded frames represent concretely. If we were to resume after <code class="language-text">throw &quot;can&#39;t be a zero!&quot;</code>, then we should</p>
<ol>
<li><code class="language-text">return n + 1</code> from <code class="language-text">oneMoreIndirection</code></li>
<li>then <code class="language-text">return x * 2</code> from <code class="language-text">unsafeOperation</code></li>
<li>then return to …hmmm</li>
</ol>
<p>Where should we return after? It must be somewhere inside <code class="language-text">handler</code> but where exactly? The control is now inside <code class="language-text">catch</code> but it may not be obvious where our continuation would fit. But remember, exceptions work through a double decision</p>
<ol>
<li>control is transferred to the most recent enclosing handler</li>
<li>the stack frames from the throwing function up to the handler are discarded</li>
</ol>
<p>So what happens if we keep decision (1) but change (2): the stack frames aren’t discarded but reified as a function (a delimited continuation), which is provided as argument to the handler? In an hypothetical JavaScript, this would look like:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">unsafeOperation</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token comment">/**/</span>resume<span class="token comment">/**/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Now it may not be obvious what should we do with <code class="language-text">resume</code>. After all, it doesn’t make much sense to resume a function that has already aborted. But that’s only if we consider non-local control transfer as exclusively meant to signal exceptions. What if we could use it in a more general way, as a sort of interaction between a (maybe deeply nested) function and an enclosing handler?</p>
<p>The function can <em>throw a request</em>, and the handler interprets the request then resumes the function using the provided continuation. As with exceptions, the function doesn’t need to know anything about the handler or how the request is fullfilled. And, that’s the core idea of Algebraic Effects.</p>
<blockquote>
<p>I’m not going to discuss the motivation behind throwing effects vs executing them right away inside a function. The question just translates to why we should separate pure and impure computations, which is a whole subject ont its own.</p>
</blockquote>
<blockquote>
<p>The thing I want to mention here, is that many discussions I saw on this subject lack the required context. Many arguments that are valid in a language like Haskell aren’t necessarily transposable to a language like JavaScript. In the former, things like purity makes it easier to give a mathemtical interpretation to a program, which can be exploited by the compiler to prove many properties about the program at compile time. This isn’t the case in JavaScript, which doesn’t have the same mathematical formalism underline (for example I see no reason to forbid mutation of local varibales <strong>in</strong> JavaSript). On the other hand, I do beleive some other properties, like <a href="https://en.wikipedia.org/wiki/Principle_of_compositionality">Compositionality</a>, are equally important in any programming language.</p>
</blockquote>
<p>So back to our earlier example, here’s how the whole example may look like in our hypothetical JavaScript:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">,</span> resume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token string">"Yassine"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">oneMoreIndirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">oneMoreIndirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">throw</span> <span class="token string">"Your name, please?"</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hi </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>If you ever worked with libraries like <code class="language-text">redux-saga</code> it’s the same idea but on streoids. Here, you have full control over the effects (while in libs like <code class="language-text">redux-saga</code> the interpretation of effects is hard coded in the library). As we’ll see, you have even control over the return value of the handled computation.</p>
<p>Ok, having seen what could be JavaScript in a parallel universe, let’s go back to reality. While we’ll, probably, never see the <code class="language-text">catch</code> clause taking a continuation argument some day, we can use our old freinds, Generators, as a decent consolation.</p>
<h3>Implementing Algebraic Effects with Generators</h3>
<p>We’re going to do this in two steps.</p>
<ol>
<li>First, we’ll implement just the exception like part: transfer the control to the closest handler</li>
<li>Then we’ll add the code to capture the delimited continuation up to the handler</li>
</ol>
<p>We’ll base our implementation on this version from the last post</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">isGenerator</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> x<span class="token punctuation">.</span>next <span class="token operator">===</span> <span class="token string">"function"</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">runGenerator</span><span class="token punctuation">(</span><span class="token parameter">gen<span class="token punctuation">,</span> arg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span> <span class="token operator">=</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _return <span class="token operator">=</span> gen<span class="token punctuation">.</span>_return
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isGenerator</span><span class="token punctuation">(</span>_return<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">runGenerator</span><span class="token punctuation">(</span>_return<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> _return <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_return</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isGenerator</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value<span class="token punctuation">.</span>_return <span class="token operator">=</span> gen
      <span class="token function">runGenerator</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">value</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">gen<span class="token punctuation">,</span> onDone</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  gen<span class="token punctuation">.</span>_return <span class="token operator">=</span> onDone
  <span class="token function">runGenerator</span><span class="token punctuation">(</span>gen<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Quick remainder, the code relies on a <code class="language-text">_return</code> field on the Generator, which points to the parent Generator. Inside a Generator, we can either yield a call to a child Generator (in which case we set its <code class="language-text">_return</code> to the current one), or yield a suspended computation (just a fancy name for a function taking the current Generator).</p>
<p>First, let’s add the equivalent of our <code class="language-text">try/catch</code> clause.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">withHandler</span><span class="token punctuation">(</span><span class="token parameter">handler<span class="token punctuation">,</span> gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">withHandlerFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> gen
    <span class="token comment">// eventually handles the return value</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">.</span>return <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">yield</span> handler<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> withHandlerGen <span class="token operator">=</span> <span class="token function">withHandlerFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  withHandlerGen<span class="token punctuation">.</span>_handler <span class="token operator">=</span> handler
  <span class="token keyword">return</span> withHandlerGen
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>First thing we need is to run <code class="language-text">withHandler</code> in its own Generator, this way it’ll have its own stack frame</li>
<li>We save the provided handler in a <code class="language-text">_handler</code> field in <code class="language-text">withHandler</code>’s own Generator</li>
<li>Inside this Generator, we run the provided computation</li>
<li>The handler may eventually handle the return value of the computation, we’ll see later how it can be useful</li>
</ul>
<p>For example:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> abortHandler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//optional, handles the return value</span>
  <span class="token operator">*</span><span class="token keyword">return</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">*</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">withHandler</span><span class="token punctuation">(</span>abortHandler<span class="token punctuation">,</span> <span class="token function">someFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>We set <code class="language-text">abortHandler</code> as a handler for all <code class="language-text">abort</code> effects thrown from inside <code class="language-text">someFunc()</code>. The function, or one of its children, can use <code class="language-text">perform(&quot;abort&quot;, msg)</code> to throw an exception that will bubbles up to the handler.</p>
<p>Below our first implementation of <code class="language-text">perform</code> (note we don’t capture the continuation)</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token parameter">performGen</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// finds the closest handler for effect `type`</span>
    <span class="token keyword">let</span> withHandlerGen <span class="token operator">=</span> performGen
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      withHandlerGen<span class="token punctuation">.</span>_handler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
      <span class="token operator">!</span>withHandlerGen<span class="token punctuation">.</span>_handler<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>withHandlerGen<span class="token punctuation">.</span>_return <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">break</span>
      withHandlerGen <span class="token operator">=</span> withHandlerGen<span class="token punctuation">.</span>_return
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      withHandlerGen<span class="token punctuation">.</span>_handler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
      <span class="token operator">!</span>withHandlerGen<span class="token punctuation">.</span>_handler<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unhandled Effect </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// found a handler, get the withHandler Generator</span>
    <span class="token keyword">const</span> handlerFunc <span class="token operator">=</span> withHandlerGen<span class="token punctuation">.</span>_handler<span class="token punctuation">[</span>type<span class="token punctuation">]</span>
    <span class="token keyword">const</span> handlerGen <span class="token operator">=</span> <span class="token function">handlerFunc</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    <span class="token comment">// will return to the parent of withHandler</span>
    handlerGen<span class="token punctuation">.</span>_return <span class="token operator">=</span> withHandlerGen<span class="token punctuation">.</span>_return
    <span class="token function">runGenerator</span><span class="token punctuation">(</span>handlerGen<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The function returns a suspended computation that does the following</p>
<ol>
<li>lookup for the closest handler that can handle <code class="language-text">type</code> like effects</li>
<li>if we can’t find a suitable handler, we throw (for real this time) an error</li>
<li>if a matching handler is found, we instantiate its function with the effect data</li>
<li>set the <code class="language-text">_return</code> address of the handler’s Generator to the parent of <code class="language-text">withHandler</code> clause</li>
<li>run the handler’s Generator</li>
</ol>
<p>Note the last step means we’re purely ignoring <code class="language-text">performGen</code>, which corresponds to how <code class="language-text">catch</code> discards the throwing function.</p>
<p>Let’s see how it works with the earlier error handling example adapted to Generators</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> abort <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">handler</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">withHandler</span><span class="token punctuation">(</span>abort<span class="token punctuation">,</span> <span class="token function">unsafeOperation</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">unsafeOperation</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">oneMoreIndirection</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
  <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">oneMoreIndirection</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// throw</span>
    <span class="token keyword">yield</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token string">"abort"</span><span class="token punctuation">,</span> <span class="token string">"can't be under zero!"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> n <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token comment">// => 6</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token comment">// => can't be under zero!</span>
<span class="token comment">// => 0</span></code></pre></div>
<p>Let’s take a closer look to how <code class="language-text">perform</code>/<code class="language-text">withHandler</code> work together in this case.</p>
<p>Since <code class="language-text">withHandler</code> doesn’t change the Call Stack, but just wraps the given Generator and sets a special <code class="language-text">_handler</code> field, when we reach the <code class="language-text">oneMoreIndirection(-1)</code> the stack looks like this:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main(-1) -&gt; handler(-1) -&gt; withHandler({abort}) -&gt; unsafeOperation(-1) -&gt;  oneMoreIndirection(-1)</code></pre></div>
<p><code class="language-text">yield perform(&quot;abort&quot;, msg)</code> finds the closest handler, which becomes the direct child for the parent of <code class="language-text">withHandler</code> clause:</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main(-1) -&gt; handler(-1) -&gt; abort(msg)</code></pre></div>
<p>Notice how this is similar to <code class="language-text">shift</code>/<code class="language-text">reset</code> we saw in the previous post. When <code class="language-text">shift</code> doesn’t use the captured continuation, it effectively discards all the stack frames up to, and including, the <code class="language-text">reset</code> block. <code class="language-text">shift</code> repalces, then, the whole surrounding <code class="language-text">reset</code> block and becomes the main expression of <code class="language-text">reset</code>’s parent. In fact, <code class="language-text">shift</code>/<code class="language-text">reset</code> presents much more similaralities with <code class="language-text">perform</code>/<code class="language-text">withHanndler</code> as we’ll see in a moment.</p>
<h4>Capturing the delimited continuation</h4>
<p>We shall, now, generalize our exception like handling by providing the handler with a delimited continuation that represents the previously discarded stack frames. This time, however, we’ll proceed differently. Before jumping into the code, we’ll start with a usage example, analyze how things should work in this example, then show the implementation.</p>
<p>The example uses a <code class="language-text">read</code> effect to get a value from the surrounding environment. For our purpose, the handler will interpret the effect with a constant value.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// define the `read` handler</span>
<span class="token keyword">const</span> constRead <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> resume</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token string">"Stranger"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">withHandler</span><span class="token punctuation">(</span>constRead<span class="token punctuation">,</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">greet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">withCivility</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hi, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">withCivility</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// throw the `read` effect</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">M. </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token comment">// => Hi, M.Stranger;</span></code></pre></div>
<p>Assuming we have a working <code class="language-text">perform</code> implementation, let’s envision how the example should manipulate the Call Stack. As always, nothing happens until we reach <code class="language-text">withCivility()</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; withHandler({read}) -&gt; greet() -&gt; withCivility()</code></pre></div>
<p>When performing the <code class="language-text">read</code> effect, we know from the previous example that the handler will become the direct child of <code class="language-text">main()</code>. However, the intermediate frames, previously discarded, will now become the delimited continuation provided to the <code class="language-text">read</code> handler</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; read(_, &lt;&lt;withHandler({read}) -&gt; greet() -&gt; withCivility()&gt;&gt;)</code></pre></div>
<p>We should point to an important thing here. The captured continuation is still wrapped by <code class="language-text">withHandler({read})</code>, this is essential because we still want to handle further <code class="language-text">read</code> effects from the rest of the computation. Notice, also, that the <code class="language-text">read</code> handler runs outside <code class="language-text">withHandler({read})</code> scope, this is also important, this handler may, itself, forward <code class="language-text">read</code> effects (or any other effect) to an upstream handler. This makes it possible to compose different handlers. Each handler in the chain may perform some preprocessing then delegate the same (or another) effect to a parent handler.</p>
<p>So, now when <code class="language-text">read</code>’s handler resumes the delimited continuation the stack becomes</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; read(_, &lt;&lt;&gt;&gt;) -&gt; withHandler({read}) -&gt; greet() -&gt; withCivility()</code></pre></div>
<p>Note our continuations can only be invoked once (one shot). This is repersented by setting the second argument of <code class="language-text">read</code> to <code class="language-text">&lt;&lt;&gt;&gt;</code>.</p>
<p>In the case <code class="language-text">withCivility</code> performs a second <code class="language-text">read</code> effect, it will be trapped again by the surrounding <code class="language-text">withHandler</code> and a new handler instance will be created and inserted into the stack. The parent of the new handler will be <code class="language-text">withHandler({rad})</code>’s parent, which in this case the former <code class="language-text">read</code> handler.</p>
<p>Ok, having seen an example of how <code class="language-text">perform</code> should manipulate the Call Stack. Let’s put it into actual code</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token parameter">performGen</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// finds the closest handler for effect `type`</span>
    <span class="token keyword">let</span> withHandlerGen <span class="token operator">=</span> performGen
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      withHandlerGen<span class="token punctuation">.</span>_handler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
      <span class="token operator">!</span>withHandlerGen<span class="token punctuation">.</span>_handler<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>withHandlerGen<span class="token punctuation">.</span>_return <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">break</span>
      withHandlerGen <span class="token operator">=</span> withHandlerGen<span class="token punctuation">.</span>_return
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      withHandlerGen<span class="token punctuation">.</span>_handler <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
      <span class="token operator">!</span>withHandlerGen<span class="token punctuation">.</span>_handler<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unhandled Effect </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// found a handler, get the withHandler Generator</span>
    <span class="token keyword">const</span> handlerFunc <span class="token operator">=</span> withHandlerGen<span class="token punctuation">.</span>_handler<span class="token punctuation">[</span>type<span class="token punctuation">]</span>

    <span class="token keyword">const</span> handlerGen <span class="token operator">=</span> <span class="token function">handlerFunc</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token parameter">currentGen</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        withHandlerGen<span class="token punctuation">.</span>_return <span class="token operator">=</span> currentGen
        <span class="token function">runGenerator</span><span class="token punctuation">(</span>performGen<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// will return to the parent of withHandler</span>
    handlerGen<span class="token punctuation">.</span>_return <span class="token operator">=</span> withHandlerGen<span class="token punctuation">.</span>_return
    <span class="token function">runGenerator</span><span class="token punctuation">(</span>handlerGen<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The key code is</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token parameter">currentGen</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    withHandlerGen<span class="token punctuation">.</span>_return <span class="token operator">=</span> currentGen
    <span class="token function">runGenerator</span><span class="token punctuation">(</span>performGen<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>It gives its meaning to the line <code class="language-text">const result = yield resume(&quot;Stranger&quot;)</code> in the handler code. Especially, <code class="language-text">withHandlerGen._return = currentGen</code> delimits the continuation starting from <code class="language-text">performGen</code> (the Generator that performed the effect) to <code class="language-text">currentGen</code> (the Generator that executed <code class="language-text">yield resume(...)</code>).</p>
<p>You may have noticed how the implementation of <code class="language-text">withHandler</code>/<code class="language-text">perform</code> looks similar to <code class="language-text">shift</code>/<code class="language-text">reset</code> from the previous post:</p>
<ul>
<li><code class="language-text">reset</code> puts a special mark on a satck frame</li>
<li><code class="language-text">withHandler</code> installs a handler on a stack frame</li>
<li><code class="language-text">shift</code> finds the closest <code class="language-text">reset</code> and becomes the direct child of <code class="language-text">reset</code>’s parent</li>
<li><code class="language-text">perform</code> finds the closest &#x26; matching <code class="language-text">withHandler</code>, the matching handler becomes the direct child of <code class="language-text">withHandler</code>’s parent</li>
<li><code class="language-text">shift</code> captures all the intermediate frames and reifies them into an argument to its computation</li>
<li><code class="language-text">perform</code> captures all the intermediate frames and reifies them into an argument to the matching handler</li>
</ul>
<p>In fact, Algebraic Effects can be seen as a more structured alternative to delimited continuations.</p>
<p>Voilà, that’s all mechanics of Algebraic Effects in action. In the remaining of this post, we’ll see some more examples.</p>
<h3>Example 1: reverse logging</h3>
<p>Our first example will be a <code class="language-text">log</code> handler that prints the logged messages in the reverse order. It may look a little fancy, but should give us a more firm understanding of the mechanics.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">perform</span><span class="token punctuation">(</span><span class="token string">"log"</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> reverseLog <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> resume</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">withHandler</span><span class="token punctuation">(</span>reverseLog<span class="token punctuation">,</span> <span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Let’s see the Call stack before performing the first <code class="language-text">log</code> effect</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; withHandler({reverseLog}) -&gt; parent() -&gt; child()</code></pre></div>
<p>After <code class="language-text">yield log(&quot;A&quot;)</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; log(&quot;A&quot;, &lt;&lt;withHandler({reverseLog}) -&gt; parent() -&gt; child()&gt;&gt;)</code></pre></div>
<p>The handler invokes the continuation before logging the message so</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; log(&quot;A&quot;, &lt;&lt;&gt;&gt;) -&gt; withHandler({reverseLog}) -&gt; parent() -&gt; child()</code></pre></div>
<p>After <code class="language-text">yield log(&quot;B&quot;)</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; log(&quot;A&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;B&quot;, &lt;&lt;withHandler({reverseLog}) -&gt; parent() -&gt; child()&gt;&gt;)</code></pre></div>
<p>Again the second handler instance invokes the continuation before logging, so</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; log(&quot;A&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;B&quot;, &lt;&lt;&gt;&gt;) -&gt; withHandler({reverseLog}) -&gt; parent() -&gt; child()</code></pre></div>
<p>After <code class="language-text">yield log(&quot;C&quot;)</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; log(&quot;A&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;B&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;C&quot;, &lt;&lt;withHandler({reverseLog}) -&gt; parent() -&gt; child()&gt;&gt;)</code></pre></div>
<p>After the third handler instance invokes the continuation</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; log(&quot;A&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;B&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;C&quot;, &lt;&lt;&gt;&gt;) -&gt; withHandler({reverseLog}) -&gt; parent() -&gt; child()</code></pre></div>
<p><code class="language-text">child()</code>, <code class="language-text">parent()</code>, <code class="language-text">withHandler({reverseLog})</code> terminate successively, which results in the following Call Stack</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; log(&quot;A&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;B&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;C&quot;, &lt;&lt;&gt;&gt;)</code></pre></div>
<p>The logs will now resume starting from rightmost stack frame, which prints the messages in the reverse order.</p>
<h3>Example 2: collecting logs</h3>
<p>This one collects the logs in an array instead of logging them</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> collectLogs <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">*</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> resume</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> acc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> {acc}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">withHandler</span><span class="token punctuation">(</span>collectLogs<span class="token punctuation">,</span> <span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span>
  <span class="token keyword">yield</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">10</span>
<span class="token punctuation">}</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token comment">// => [10, "A B C "]</span></code></pre></div>
<p>After the third handler instance invokes the continuation, we endup with</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; log(&quot;A&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;B&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;C&quot;, &lt;&lt;&gt;&gt;) -&gt; withHandler({collectLogs}) -&gt; parent() -&gt; child()</code></pre></div>
<p><code class="language-text">child()</code> returns <code class="language-text">10</code> to <code class="language-text">parent()</code>, which returns the same value to <code class="language-text">withHandler({collectLogs})</code></p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">main() -&gt; log(&quot;A&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;B&quot;, &lt;&lt;&gt;&gt;) -&gt; log(&quot;C&quot;, &lt;&lt;&gt;&gt;) -&gt; withHandler({collectLogs})</code></pre></div>
<p>Since <code class="language-text">collectLogs</code> has defined a <code class="language-text">return</code> clause, the value will be processed by the matching handler, which results in <code class="language-text">withHandler({collectLogs})</code> returning <code class="language-text">[10, &quot;&quot;]</code> to its parent <code class="language-text">log(&quot;C&quot;)</code>. This one concats <code class="language-text">&quot;&quot;</code> (<code class="language-text">acc</code>) with <code class="language-text">&quot;C&quot;</code> (<code class="language-text">msg</code>) and returns <code class="language-text">[10, &quot;C &quot;]</code> to <code class="language-text">log(&quot;B&quot;)</code>. The whole process results in <code class="language-text">[10, &quot;A B C &quot;]</code> being returned</p>
<h3>Combining handlers</h3>
<p>Here we compose the two precedent handlers</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> reverseLog <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">*</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> resume</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">yield</span> <span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> collectLogs <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">*</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> resume</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> acc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>acc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">withHandler</span><span class="token punctuation">(</span>collectLogs<span class="token punctuation">,</span> <span class="token function">withHandler</span><span class="token punctuation">(</span>reverseLog<span class="token punctuation">,</span> <span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// ... rest unmodified</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span>log<span class="token punctuation">)</span>
<span class="token comment">// => C</span>
<span class="token comment">// => B</span>
<span class="token comment">// => A</span>
<span class="token comment">// => [undefined, "C B A "]</span></code></pre></div>
<p>The first handler prints the message in the reverse order, then forwards the <code class="language-text">log</code> effect to <code class="language-text">collectLogs</code>, since the logs are forwarded in the reverse order, they endup collected also in the reverse order.</p>
<h3>Conclusion</h3>
<p>There are many other examples (state, async, …). Some simple ones could be found <a href="https://github.com/yelouafi/algebraic-effects.js/tree/master/examples">here</a>. If you feel more adventurous, you can consult <a href="https://github.com/kayceesrk/effects-examples">this collection of ocaml examples</a> (not all of them would be applicable in JavaScript).</p>
<p>This concludes our series about Algebraic Effects &#x26; Handlers. Hope it wasn’t too booring, and thanks again for being a patient reader!</p>
<h3>Some references</h3>
<ul>
<li><a href="https://www.eff-lang.org/handlers-tutorial.pdf">An Introduction to Algebraic Effects and Handlers using Eff language</a></li>
<li><a href="https://www.youtube.com/watch?v=hrBq8R_kxI0">A talk about Algebraic Effects using the language Koka</a></li>
<li><a href="https://arxiv.org/abs/1807.05923">What’s algebraic about Algebraic Effects</a>, if you feel more adventurous. (hint: In programming world, the arity of an algebraic operation isn’t the number of params but the number of the possible outcomes, the interpretation <code class="language-text">I^A -&gt; I</code> can be translated into <code class="language-text">(A -&gt; I) -&gt; I</code> (function == exponential) which is also the siganture of a CPS function that invokes its continuation <code class="language-text">(A -&gt; I)</code> with a value of type <code class="language-text">A</code>, the same siganture of a handler, example: a boolean type has 2 possible outcomes <code class="language-text">Bool -&gt; I -&gt; I</code> can be seen as <code class="language-text">I^2 -&gt; I</code>; please don’t ask me more!)</li>
</ul></section><hr/><footer><div class="bio"><p>Written by<!-- --> <a href="https://twitter.com/YassineElouafi2"><strong>Yassine EL Ouafi</strong></a></p></div></footer></article><nav class="blog-post-nav"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/2018-11-19-algebraic-effects-series-3/">← <!-- -->Algebraic Effects in JavaScript part 3 - Delimited Continuations</a></li><li><a rel="next" href="/2018-11-23-typing-optics/">Typing Optics with TypeScript<!-- --> →</a></li></ul></nav></main><footer></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2018-11-19-algebraic-effects-series-4/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-d2a314c619ae9d8e67ff.js"],"app":["/app-be01091e8f6277f5b6f6.js"],"component---src-pages-404-js":["/component---src-pages-404-js-97593667e44e4660bc60.js"],"component---src-pages-index-js":["/component---src-pages-index-js-6725867a2b20a509cc57.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-ec89e82605e2a0c5e9c7.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-664fa24895fa0bb62323.js"]};/*]]>*/</script><script src="/polyfill-d2a314c619ae9d8e67ff.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-664fa24895fa0bb62323.js" async=""></script><script src="/commons-140fdb61bcb6fdaf6bd2.js" async=""></script><script src="/app-be01091e8f6277f5b6f6.js" async=""></script><script src="/framework-c4b9952841844d9091bc.js" async=""></script><script src="/webpack-runtime-787195f1393efa40968d.js" async=""></script></body></html>